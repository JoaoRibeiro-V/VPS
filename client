import java.io.*;
import java.net.*;
import java.util.*;

public class BroadcastClient {
    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        System.out.print("Enter your username: ");
        String username = scanner.nextLine();

        String postUrl = "https://<your-codespace-id>-8080.app.github.dev/message";
        String fetchUrl = "https://<your-codespace-id>-8080.app.github.dev/fetch";

        // Start a thread to poll messages every 2 seconds
        new Thread(() -> {
            Set<String> seen = new HashSet<>();
            while (true) {
                try {
                    URL url = new URL(fetchUrl);
                    HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                    conn.setRequestMethod("GET");
                    BufferedReader in = new BufferedReader(
                            new InputStreamReader(conn.getInputStream(), "UTF-8"));
                    String line;
                    while ((line = in.readLine()) != null) {
                        if (!seen.contains(line) && !line.trim().isEmpty()) {
                            System.out.println(line);
                            seen.add(line);
                        }
                    }
                    in.close();
                    Thread.sleep(2000);
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }).start();

        // Main loop to send messages
        while (true) {
            System.out.print("Enter message (or 'exit' to quit): ");
            String msg = scanner.nextLine();
            if ("exit".equalsIgnoreCase(msg)) break;

            try {
                URL url = new URL(postUrl);
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                conn.setRequestMethod("POST");
                conn.setDoOutput(true);

                String formatted = username + ": " + msg;
                try (OutputStream os = conn.getOutputStream()) {
                    os.write(formatted.getBytes("UTF-8"));
                }

                conn.getInputStream().close(); // just to complete the request
            } catch (Exception e) {
                e.printStackTrace();
            }
        }

        scanner.close();
    }
}